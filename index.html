<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>사진 위치 정보 지도 표시</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<!-- MarkerCluster CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

<!-- [추가 내용] Date Buttons CSS -->
<link rel="stylesheet" href="styles.css">

<style>
  /* ▼ 지도 영역 스타일 */
  #map {
    width: 100%;
    height: 100vh;
  }

  /* ▼ 마커 팝업 내 이미지 갤러리 스타일 */
  .photo-gallery {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }
  .photo-gallery img {
    width: 100px;
    height: auto;
    cursor: pointer;
    transition: transform 0.2s;
  }
  .photo-gallery img:hover {
    transform: scale(1.05);
  }

</style>
</head>
<body>
  <!-- [추가 내용] 날짜 선택 버튼 컨테이너 -->
  <div id="dateButtonsContainer" class="date-buttons-container">
    <!-- 버튼이 JavaScript로 동적으로 추가됩니다 -->
  </div>

  <div id="map"></div>

  <!-- exif-js 라이브러리 (EXIF 정보 추출용) -->
  <script src="https://unpkg.com/exif-js"></script>
  <!-- Leaflet 라이브러리 -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- MarkerCluster 플러그인 -->
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

  <script>
    // =============================
    // [변경 및 추가 내용 - 클라이언트 로직]
    // 1. /api/image_data를 호출해 images 폴더 내 JPG 파일 리스트를 동적으로 가져옴
    // 2. 각 이미지에 대해 EXIF GPS 정보 처리
    // 3. 위치 정보가 있는 이미지들을 좌표별로 그룹화
    // 4. 같은 위치(또는 매우 근접한 위치)에 여러 이미지가 있을 경우, 
    //    클러스터 마커를 사용하여 UI 개선
    // 5. 마커 클릭 시 해당 위치의 모든 이미지를 하나의 팝업에 갤러리 형태로 표시
    // 6. 날짜 선택 버튼을 통해 특정 날짜의 사진만 지도에 표시
    // =============================

    // Leaflet 지도 초기화
    var map = L.map('map').setView([35.0, 135.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // 마커 클러스터 그룹 생성
    var markers = L.markerClusterGroup();
    map.addLayer(markers);

    // 위치별로 이미지들을 그룹화하기 위한 맵(키: 'lat,lng' 문자열, 값: 이미지 리스트)
    var locationMap = {};
    var allDates = new Set(); // 모든 날짜를 저장할 Set
    var imageData = []; // 모든 이미지 데이터를 저장할 배열

    // 서버에서 이미지 데이터 가져오기
    fetch('/api/image_data')
      .then(res => res.json())
      .then(data => {
        // data: [{ path: 'images/xxx.jpg', lat: ..., lng: ..., date: 'YYYY-MM-DD' }, ...]
        
        imageData = data; // 이미지 데이터를 전역 변수에 저장

        // 모든 날짜를 Set에 추가
        data.forEach(item => {
          allDates.add(item.date);
        });

        // 날짜 선택 버튼 생성
        createDateButtons(Array.from(allDates).sort());

        // 초기 로드 시 첫 번째 날짜의 이미지를 표시
        const sortedDates = Array.from(allDates).sort();
        if (sortedDates.length > 0) {
          displayImagesByDate(sortedDates[0]);
          // [추가 내용] 첫 번째 날짜 버튼 활성화
          const firstButton = document.querySelector('.date-button');
          if (firstButton) {
            firstButton.classList.add('active');
          }
        }
      })
      .catch(err => {
        console.log("에러 발생:", err);
      });

    // 날짜 선택 버튼 생성 함수
    function createDateButtons(dates) {
      var container = document.getElementById('dateButtonsContainer');

      dates.forEach(dateStr => {
        // 날짜 문자열을 "MM/DD(요일)" 형식으로 변환
        var formattedDate = formatDateButton(dateStr);
        var button = document.createElement('button');
        button.innerText = formattedDate;
        button.classList.add('date-button');
        button.addEventListener('click', function() {
          // 모든 버튼에서 active 클래스 제거
          var buttons = document.querySelectorAll('.date-button');
          buttons.forEach(btn => btn.classList.remove('active'));
          // 클릭한 버튼에 active 클래스 추가
          this.classList.add('active');
          // 선택된 날짜의 이미지 표시
          displayImagesByDate(dateStr);
        });
        container.appendChild(button);
      });
    }

    // 날짜 버튼 텍스트 형식 변환 함수
    function formatDateButton(dateStr) {
      // dateStr: 'YYYY-MM-DD'
      var date = new Date(dateStr);
      var month = String(date.getMonth() + 1).padStart(2, '0');
      var day = String(date.getDate()).padStart(2, '0');
      var dayOfWeek = getKoreanDayOfWeek(date.getDay());
      return `${month}/${day}(${dayOfWeek})`;
    }

    // 요일을 한글로 반환하는 함수
    function getKoreanDayOfWeek(day) {
      var days = ['일', '월', '화', '수', '목', '금', '토'];
      return days[day];
    }

    // 특정 날짜의 이미지를 지도에 표시하는 함수
    function displayImagesByDate(selectedDate) {
      // ▼ 기존 마커 클러스터 그룹 초기화
      markers.clearLayers();

      // 위치별로 이미지들을 그룹화하기 위한 맵 초기화
      locationMap = {};

      // 모든 이미지 데이터를 순회하며 선택된 날짜의 이미지만 필터링
      imageData.forEach(item => {
        if (item.date === selectedDate) {
          var key = item.lat.toFixed(5) + "," + item.lng.toFixed(5);
          if (!locationMap[key]) {
            locationMap[key] = [];
          }
          locationMap[key].push(item.path);
        }
      });

      // locationMap을 순회하며 각 위치에 마커 추가
      for (var key in locationMap) {
        var coords = key.split(",");
        var lat = parseFloat(coords[0]);
        var lng = parseFloat(coords[1]);
        var images = locationMap[key]; // 이 위치에 속한 이미지들

        var marker = L.marker([lat, lng]);

        var galleryHtml = '<div class="photo-gallery">';
        images.forEach(function(imgPath) {
          // [추가 내용] 이미지 클릭 시 큰 이미지 보기 (Lightbox 구현)
          galleryHtml += '<img src="' + imgPath + '" alt="사진" onclick="openImage(\'' + imgPath + '\', this.parentNode)" />';
        });
        galleryHtml += '</div>';

        marker.bindPopup(galleryHtml);
        markers.addLayer(marker);
      }

      if (markers.getLayers().length > 0) {
        map.fitBounds(markers.getBounds());
      } else {
        console.log("선택한 날짜에 위치 정보가 있는 이미지가 없어 지도 범위를 조정하지 않습니다.");
        alert("선택한 날짜에 위치 정보가 있는 이미지가 없습니다.");
      }
    }

    // [추가 내용] 이미지 클릭 시 큰 이미지 보기 (Lightbox 예시)
    function openImage(imagePath, gallery) {
      // 기존에 lightbox가 있으면 제거
      var existingLightbox = document.getElementById('lightbox');
      if (existingLightbox) {
        existingLightbox.parentNode.removeChild(existingLightbox);
      }

      // Lightbox 생성
      const lightbox = document.createElement('div');
      lightbox.id = 'lightbox';

      // [변경] 슬라이드 기능 추가
      let images = Array.from(gallery.querySelectorAll('img')).map(img => img.src);
      // imagePath를 절대 경로로 변환
      const normalizedImagePath = new URL(imagePath, window.location.origin).href;
      const currentIndex = images.indexOf(normalizedImagePath);
      
      let sliderHtml = '<div class="image-slider">';
      images.forEach(function(imgPath, index) {
        sliderHtml += `<img src="${imgPath}" alt="큰 이미지" data-index="${index}" class="slide-image${index === currentIndex ? ' active' : ''}" />`;
      });
      sliderHtml += '<button class="slide-prev" onclick="prevSlide(this.parentNode)">&#10094;</button>';
      sliderHtml += '<button class="slide-next" onclick="nextSlide(this.parentNode)">&#10095;</button>';
      sliderHtml += '</div>';
        lightbox.innerHTML = sliderHtml;
      document.body.appendChild(lightbox);

      // Lightbox 클릭 시 제거
      lightbox.addEventListener('click', function(event) {
        if (event.target === lightbox) {
          document.body.removeChild(lightbox);
        }
      });
    }

     // [추가 내용] 슬라이드 기능
    function prevSlide(slider) {
      const images = slider.querySelectorAll('.slide-image');
      const activeImage = slider.querySelector('.slide-image.active');
      let currentIndex = parseInt(activeImage.dataset.index);
      
      activeImage.classList.remove('active');
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      images[currentIndex].classList.add('active');
    }
      function nextSlide(slider) {
      const images = slider.querySelectorAll('.slide-image');
      const activeImage = slider.querySelector('.slide-image.active');
      let currentIndex = parseInt(activeImage.dataset.index);
        activeImage.classList.remove('active');
      currentIndex = (currentIndex + 1) % images.length;
      images[currentIndex].classList.add('active');
    }
  </script>
</body>
</html>
