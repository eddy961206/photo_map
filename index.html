<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>사진 위치 정보 지도 표시</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <!-- [추가 내용] Date Buttons CSS -->
    <link rel="stylesheet" href="styles.css">
    <style>
        #map {
            width: 100%;
            height: 95vh;
        }
        .photo-gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .photo-gallery img {
            width: 100px;
            height: auto;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .photo-gallery img:hover {
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div id="dateButtonsContainer" class="date-buttons-container"></div>
    <div id="map"></div>
    <div id="timeSliderContainer">
      <label class="toggle-switch">
          <input type="checkbox" id="timeSliderToggle">
          <span class="toggle-slider"></span>
      </label>
      <label>시간 필터: <span id="timeLabel"></span></label>
      <input type="range" id="timeSlider" min="0" max="1439" value="0" list="timeTicks" disabled />
      <datalist id="timeTicks"></datalist>
    </div>
    <script src="https://unpkg.com/exif-js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var map = L.map('map').setView([35.0, 135.0], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        var markers = L.markerClusterGroup();
        map.addLayer(markers);
        var locationMap = {};
        var allDates = new Set();
        var imageData = [];
        var currentSelectedDate = null;
        var isTimeSliderEnabled = false;

        // 시간 슬라이더 토글 이벤트 리스너
        $('#timeSliderToggle').on('change', function() {
            isTimeSliderEnabled = $(this).prop('checked');
            $('#timeSlider').prop('disabled', !isTimeSliderEnabled);

            if (currentSelectedDate) {
                if (isTimeSliderEnabled) {
                    const selectedMinutes = parseInt($('#timeSlider').val(), 10);
                    displayImagesByDateAndTime(currentSelectedDate, selectedMinutes);
                } else {
                    displayImagesByDate(currentSelectedDate);
                }
            }
        });

        $.ajax({
            url: '/api/image_data',
            method: 'GET',
            dataType: 'json',
            success: function(data) {
                imageData = data;
                data.forEach(item => {
                    allDates.add(item.date);
                });

                var sortedDates = Array.from(allDates).sort();
                createDateButtons(sortedDates);
                if (sortedDates.length > 0) {
                    currentSelectedDate = sortedDates[0];
                    initializeTimeSliderForDate(currentSelectedDate);
                    displayImagesByDate(currentSelectedDate);
                    $('.date-button').first().addClass('active');
                }
            },
            error: function(err) {
                console.log("에러 발생:", err);
            }
        });

        function createDateButtons(dates) {
            var container = $('#dateButtonsContainer');
            dates.forEach(dateStr => {
                var formattedDate = formatDateButton(dateStr);
                var button = $('<button></button>')
                    .text(formattedDate)
                    .addClass('date-button')
                    .on('click', function() {
                        $('.date-button').removeClass('active');
                        $(this).addClass('active');
                        currentSelectedDate = dateStr;
                        initializeTimeSliderForDate(dateStr);
                        if (isTimeSliderEnabled) {
                            const selectedMinutes = parseInt($('#timeSlider').val(), 10);
                            displayImagesByDateAndTime(dateStr, selectedMinutes);
                        } else {
                            displayImagesByDate(dateStr);
                        }
                    });
                container.append(button);
            });
        }

        function formatDateButton(dateStr) {
            var date = new Date(dateStr);
            var month = String(date.getMonth() + 1).padStart(2, '0');
            var day = String(date.getDate()).padStart(2, '0');
            var dayOfWeek = getKoreanDayOfWeek(date.getDay());
            return `${month}/${day}(${dayOfWeek})`;
        }

        function getKoreanDayOfWeek(day) {
            var days = ['일', '월', '화', '수', '목', '금', '토'];
            return days[day];
        }

        function initializeTimeSliderForDate(selectedDate) {
            const times = imageData
                .filter(item => item.date === selectedDate)
                .map(item => {
                    const [hh, mm] = item.time.split(':').map(Number);
                    return hh * 60 + mm;
                })
                .sort((a, b) => a - b);
            if (times.length === 0) {
                $('#timeSlider').attr('disabled', true);
                $('#timeLabel').text('N/A');
                return;
            }

          // datalist 업데이트
          const timeTicksElement = $('#timeTicks');
          timeTicksElement.empty();
          times.forEach(time => {
              timeTicksElement.append(`<option value="${time}">`);
          });
            $('#timeSlider').attr('disabled', !isTimeSliderEnabled);
          $('#timeSlider').attr('min', times[0]);
          $('#timeSlider').attr('max', times[times.length - 1]);
          $('#timeSlider').val(times[0]);
          updateTimeLabel(times[0]);
            // 슬라이더 이벤트 핸들러 수정
          $('#timeSlider').off('input').on('input', function() {
              const currentValue = parseInt($(this).val(), 10);
              // 가장 가까운 실제 시간값 찾기
              const closestTime = times.reduce((prev, curr) => {
                  return Math.abs(curr - currentValue) < Math.abs(prev - currentValue) ? curr : prev;
              });
              
              $(this).val(closestTime);
              updateTimeLabel(closestTime);
              if (isTimeSliderEnabled) {
                  displayImagesByDateAndTime(selectedDate, closestTime);
              }
          });
        }

        function updateTimeLabel(minutes) {
            const hh = String(Math.floor(minutes / 60)).padStart(2, '0');
            const mm = String(minutes % 60).padStart(2, '0');
            $('#timeLabel').text(`${hh}:${mm}`);
        }

        function displayImagesByDate(selectedDate) {
            markers.clearLayers();
            locationMap = {};

            imageData.forEach(item => {
                if (item.date === selectedDate) {
                    const key = item.lat.toFixed(5) + "," + item.lng.toFixed(5);
                    if (!locationMap[key]) {
                        locationMap[key] = [];
                    }
                    locationMap[key].push({
                        path: item.path,
                        time: item.time
                    });
                }
            });
            createMarkers();
        }

        function displayImagesByDateAndTime(selectedDate, selectedMinutes) {
            markers.clearLayers();
            locationMap = {};

            imageData.forEach(item => {
                if (item.date === selectedDate) {
                    const [hh, mm] = item.time.split(':').map(Number);
                    const itemMinutes = hh * 60 + mm;
                    if (itemMinutes <= selectedMinutes) {
                        const key = item.lat.toFixed(5) + "," + item.lng.toFixed(5);
                        if (!locationMap[key]) {
                            locationMap[key] = [];
                        }
                        locationMap[key].push({
                            path: item.path,
                            time: item.time
                        });
                    }
                }
            });
            createMarkers();
        }

        function createMarkers() {
            for (var key in locationMap) {
                var coords = key.split(",");
                var lat = parseFloat(coords[0]);
                var lng = parseFloat(coords[1]);
                var images = locationMap[key];
                var marker = L.marker([lat, lng]);
                var popupContent = '<div class="photo-gallery-container">';

                // 시간순으로 정렬
                images.sort((a, b) => a.time.localeCompare(b.time));

                images.forEach(function(image) {
                    popupContent += `<div class="photo-time">촬영 시간: ${image.time}</div>`;
                    popupContent += `<img src="${image.path}" alt="사진" onclick="openImage('${image.path}', this.parentNode)" />`;
                });
                popupContent += '</div>';
                marker.bindPopup(popupContent);
                markers.addLayer(marker);
            }

            if (markers.getLayers().length > 0) {
                map.fitBounds(markers.getBounds());
            } else {
                console.log("선택한 범위 내에 표시할 이미지가 없습니다.");
            }
        }

        function openImage(imagePath, gallery) {
            var existingLightbox = $('#lightbox');
            if (existingLightbox.length) {
                existingLightbox.remove();
            }

            const lightbox = $('<div></div>').attr('id', 'lightbox');
            let images = Array.from(gallery.querySelectorAll('img')).map(img => img.src);
            const normalizedImagePath = new URL(imagePath, window.location.origin).href;
            const currentIndex = images.indexOf(normalizedImagePath);
            let sliderHtml = '<div class="image-slider">';
            images.forEach(function(imgPath, index) {
                sliderHtml += `<img src="${imgPath}" alt="큰 이미지" data-index="${index}" class="slide-image${index === currentIndex ? ' active' : ''}" />`;
            });
            sliderHtml += '<button class="slide-prev" onclick="prevSlide(this.parentNode)">&#10094;</button>';
            sliderHtml += '<button class="slide-next" onclick="nextSlide(this.parentNode)">&#10095;</button>';
            sliderHtml += '</div>';
            lightbox.html(sliderHtml);
            $('body').append(lightbox);

            lightbox.on('click', function(event) {
                if (event.target === lightbox[0]) {
                    lightbox.remove();
                }
            });
        }

        function prevSlide(slider) {
            const images = $(slider).find('.slide-image');
            const activeImage = $(slider).find('.slide-image.active');
            let currentIndex = parseInt(activeImage.data('index'), 10);

            activeImage.removeClass('active');
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            $(images[currentIndex]).addClass('active');
        }

        function nextSlide(slider) {
            const images = $(slider).find('.slide-image');
            const activeImage = $(slider).find('.slide-image.active');
            let currentIndex = parseInt(activeImage.data('index'), 10);

            activeImage.removeClass('active');
            currentIndex = (currentIndex + 1) % images.length;
            $(images[currentIndex]).addClass('active');
        }
    </script>
</body>
</html>